"use strict";(self.webpackChunkproject_structure=self.webpackChunkproject_structure||[]).push([[197],{348:(e,t,s)=>{s.d(t,{Z:()=>r});var i=s(856);function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class r{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],{url:t="",sorted:s={id:e.find(e=>e.sortable).id,order:"asc"},isSortLocally:i=!1,step:r=20,start:a=1,end:l=a+r,from:o=null,to:d=null,filtered:h=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,"element",void 0),n(this,"subElements",{}),n(this,"data",[]),n(this,"loading",!1),n(this,"step",20),n(this,"start",1),n(this,"end",this.start+this.step),n(this,"onWindowScroll",async()=>{const{bottom:e}=this.element.getBoundingClientRect(),{id:t,order:s}=this.sorted;if(e<document.documentElement.clientHeight&&!this.loading&&!this.isSortLocally){this.start=this.end,this.end=this.start+this.step,this.loading=!0;const e=await this.loadData(t,s,this.start,this.end);this.update(e),this.loading=!1}}),n(this,"onSortClick",e=>{const t=e.target.closest('[data-sortable="true"]');if(t){const{id:e,order:s}=t.dataset,i=(e=>({asc:"desc",desc:"asc"}[e]))(s);this.sorted={id:e,order:i},t.dataset.order=i,t.append(this.subElements.arrow),this.isSortLocally?this.sortLocally(e,i):(this.start=1,this.end=1+this.step,this.sortOnServer(e,i,this.start,this.end))}}),this.headersConfig=e,this.url=new URL(t,"https://course-js.javascript.ru/"),this.sorted=s,this.isSortLocally=i,this.step=r,this.start=a,this.end=l,this.from=o,this.to=d,this.filtered=h,this.render()}async render(){const{id:e,order:t}=this.sorted,s=document.createElement("div");s.innerHTML=this.getTable();const i=s.firstElementChild;this.element=i,this.subElements=this.getSubElements(i);const n=await this.loadData(e,t,this.start,this.end);return this.renderRows(n),this.initEventListeners(),this.element}async loadData(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.start,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.end;if(this.from&&this.to&&(this.url.searchParams.set("createdAt_gte",this.from),this.url.searchParams.set("createdAt_lte",this.to)),this.filtered){const{price_gte:e,price_lte:t,title_like:s,status:i}=this.filtered;this.url.searchParams.set("price_gte",e),this.url.searchParams.set("price_lte",t),s&&this.url.searchParams.set("title_like",s),i&&this.url.searchParams.set("status",i)}this.url.searchParams.set("_sort",e),this.url.searchParams.set("_order",t),this.url.searchParams.set("_start",s),this.url.searchParams.set("_end",n),this.element.classList.add("sortable-table_loading");const r=await(0,i.Z)(this.url);return this.element.classList.remove("sortable-table_loading"),r}addRows(e){this.data=e,this.subElements.body.innerHTML=this.getTableRows(e),e.length?this.element.classList.remove("sortable-table_empty"):this.element.classList.add("sortable-table_empty")}update(e){const t=document.createElement("div");return this.data=[...this.data,...e],t.innerHTML=this.getTableRows(e),this.subElements.body.append(...t.childNodes),t}getTableHeader(){return`<div data-element="header" class="sortable-table__header sortable-table__row">\n      ${this.headersConfig.map(e=>this.getHeaderRow(e)).join("")}\n    </div>`}getHeaderRow(e){let{id:t,title:s,sortable:i}=e;return`\n      <div class="sortable-table__cell" data-id="${t}" data-sortable="${i}" data-order="${this.sorted.id===t?this.sorted.order:"asc"}">\n        <span>${s}</span>\n        ${this.getHeaderSortingArrow(t)}\n      </div>\n    `}getHeaderSortingArrow(e){return(this.sorted.id===e?this.sorted.order:"")?'<span data-element="arrow" class="sortable-table__sort-arrow">\n          <span class="sort-arrow"></span>\n        </span>':""}getTableBody(e){return`\n      <div data-element="body" class="sortable-table__body">\n        ${this.getTableRows(e)}\n      </div>`}getTableRows(e){return e.map(t=>`\n      <a href="/products/${t.id}" class="sortable-table__row">\n        ${this.getTableRow(t,e)}\n      </a>`).join("")}getTableRow(e){return this.headersConfig.map(e=>{let{id:t,template:s}=e;return{id:t,template:s}}).map(t=>{let{id:s,template:i}=t;return i?i(e[s]):`<div class="sortable-table__cell">${e[s]}</div>`}).join("")}getTable(){return`\n      <div class="sortable-table">\n        ${this.getTableHeader()}\n        ${this.getTableBody(this.data)}\n\n        <div data-element="loading" class="loading-line sortable-table__loading-line"></div>\n\n        <div data-element="emptyPlaceholder" class="sortable-table__empty-placeholder">\n          No data\n        </div>\n      </div>`}initEventListeners(){this.subElements.header.addEventListener("pointerdown",this.onSortClick),document.addEventListener("scroll",this.onWindowScroll)}sortLocally(e,t){const s=this.sortData(e,t);this.subElements.body.innerHTML=this.getTableBody(s)}async sortOnServer(e,t,s,i){const n=await this.loadData(e,t,s,i);this.renderRows(n)}renderRows(e){e.length?(this.element.classList.remove("sortable-table_empty"),this.addRows(e)):this.element.classList.add("sortable-table_empty")}sortData(e,t){const s=[...this.data],i=this.headersConfig.find(t=>t.id===e),{sortType:n,customSorting:r}=i,a="asc"===t?1:-1;return s.sort((t,s)=>{switch(n){case"number":return a*(t[e]-s[e]);case"string":return a*t[e].localeCompare(s[e],"ru");case"custom":return a*r(t,s);default:return a*(t[e]-s[e])}})}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}remove(){this.element.remove(),document.removeEventListener("scroll",this.onWindowScroll)}destroy(){this.remove(),this.subElements={}}}},747:(e,t,s)=>{s.r(t),s.d(t,{default:()=>c});var i=s(348);function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class r{constructor(){let{min:e=100,max:t=200,formatValue:s=(e=>"$"+e),selected:i={from:e,to:t}}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,"element",void 0),n(this,"subElements",{}),n(this,"onThumbPointerMove",e=>{e.preventDefault();const{thumbLeft:t,thumbRight:s,inner:i,progress:n,from:r,to:a}=this.subElements,{left:l,right:o,width:d}=i.getBoundingClientRect();if(this.dragging===t){let t=(e.clientX-l+this.shiftX)/d;t<0&&(t=0),t*=100;const i=parseFloat(s.style.right);t+i>100&&(t=100-i),this.dragging.style.left=t+"%",n.style.left=t+"%",r.innerHTML=this.formatValue(this.getValue().from)}else{let t=(o-e.clientX-this.shiftX)/d;t<0&&(t=0),t*=100;let s=parseFloat(this.subElements.thumbLeft.style.left);s+t>100&&(t=100-s),this.dragging.style.right=t+"%",n.style.right=t+"%",a.innerHTML=this.formatValue(this.getValue().to)}}),n(this,"onThumbPointerUp",()=>{this.element.classList.remove("range-slider_dragging"),document.removeEventListener("pointermove",this.onThumbPointerMove),document.removeEventListener("pointerup",this.onThumbPointerUp),this.element.dispatchEvent(new CustomEvent("range-select",{detail:this.getValue(),bubbles:!0}))}),this.min=e,this.max=t,this.originalMin=this.min,this.originalMax=this.max,this.formatValue=s,this.selected=i,this.render()}get template(){const{from:e,to:t}=this.selected;return`<div class="range-slider">\n      <span data-element="from">${this.formatValue(e)}</span>\n      <div data-element="inner" class="range-slider__inner">\n        <span data-element="progress" class="range-slider__progress"></span>\n        <span data-element="thumbLeft" class="range-slider__thumb-left"></span>\n        <span data-element="thumbRight" class="range-slider__thumb-right"></span>\n      </div>\n      <span data-element="to">${this.formatValue(t)}</span>\n    </div>`}render(){const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild,this.element.ondragstart=()=>!1,this.subElements=this.getSubElements(e),this.initEventListeners(),this.update()}initEventListeners(){const{thumbLeft:e,thumbRight:t}=this.subElements;e.addEventListener("pointerdown",e=>this.onThumbPointerDown(e)),t.addEventListener("pointerdown",e=>this.onThumbPointerDown(e))}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}remove(){this.element.remove()}destroy(){this.remove(),document.removeEventListener("pointermove",this.onThumbPointerMove),document.removeEventListener("pointerup",this.onThumbPointerUp)}update(){const{progress:e,thumbLeft:t,thumbRight:s}=this.subElements,i=this.max-this.min,n=Math.floor((this.selected.from-this.min)/i*100)+"%",r=Math.floor((this.max-this.selected.to)/i*100)+"%";e.style.left=n,e.style.right=r,t.style.left=n,s.style.right=r}reset(){const{from:e,to:t}=this.subElements;this.min=this.originalMin,this.selected.from=this.originalMin,e.innerHTML=this.formatValue(this.originalMin),this.max=this.originalMax,this.selected.to=this.originalMax,t.innerHTML=this.formatValue(this.originalMax),this.update()}onThumbPointerDown(e){const t=e.target;e.preventDefault();const{left:s,right:i}=t.getBoundingClientRect();t===this.subElements.thumbLeft?this.shiftX=i-e.clientX:this.shiftX=s-e.clientX,this.dragging=t,this.element.classList.add("range-slider_dragging"),document.addEventListener("pointermove",this.onThumbPointerMove),document.addEventListener("pointerup",this.onThumbPointerUp)}getValue(){const{thumbLeft:e,thumbRight:t}=this.subElements,s=this.max-this.min,{left:i}=e.style,{right:n}=t.style;return{from:Math.round(this.min+.01*parseFloat(i)*s),to:Math.round(this.max-.01*parseFloat(n)*s)}}}function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class l{constructor(){let{sliderMin:e=0,sliderMax:t=4e3}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};a(this,"element",void 0),a(this,"subElements",{}),a(this,"components",{}),this.sliderMin=e,this.sliderMax=t,this.render()}initComponents(){const e=new r({min:this.sliderMin,max:this.sliderMax});this.components.doubleSlider=e}get template(){return'\n    <div class="content-box content-box_small">\n      <form class="form-inline">\n        <div class="form-group">\n          <label class="form-label">Сортировать по:</label>\n          <input type="text" data-element="filterName" class="form-control" placeholder="Название товара">\n        </div>\n      <div data-element="doubleSlider">\n        \x3c!-- double-slider component --\x3e\n      </div>\n      <div class="form-group">\n        <label class="form-label">Статус:</label>\n        <select class="form-control" data-element="filterStatus">\n          <option value="" selected="">Любой</option>\n          <option value="1">Активный</option>\n          <option value="0">Неактивный</option>\n        </select>\n      </div>\n    </form>\n  </div>'}render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element),this.initComponents(),this.renderComponents(),this.element}renderComponents(){Object.keys(this.components).forEach(e=>{const t=this.subElements[e],{element:s}=this.components[e];t.append(s)})}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}destroy(){for(const e of Object.values(this.components))e.destroy()}}const o=[{id:"images",title:"Image",sortable:!1,template:e=>`\n          <div class="sortable-table__cell">\n            <img class="sortable-table-image" alt="Image" src="${e[0]?e[0].url:""}">\n          </div>\n        `},{id:"title",title:"Name",sortable:!0,sortType:"string"},{id:"subcategory",title:"Subcategory",sortable:!1,template:e=>`\n        <div class="sortable-table__cell">\n          ${e.category&&e.title?`<span data-tooltip=\n              "\n                <div class=&quot;sortable-table-tooltip&quot;>\n                  <span class=&quot;sortable-table-tooltip__category&quot;>${e.category?e.category.title:""}</span> /\n                  <b class=&quot;sortable-table-tooltip__subcategory&quot;>${e.title}</b>\n                </div>\n              ">\n                ${e.title}\n              </span> `:"-"}\n        </div>\n        `},{id:"quantity",title:"Quantity",sortable:!0,sortType:"number"},{id:"price",title:"Price",sortable:!0,sortType:"number",template:e=>`<div class="sortable-table__cell">$${e}</div>`},{id:"status",title:"Status",sortable:!0,sortType:"number",template:e=>`<div class="sortable-table__cell">\n          ${e>0?"Active":"Inactive"}\n        </div>`}];var d=s(856);function h(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class c{constructor(){h(this,"element",void 0),h(this,"subElements",{}),h(this,"components",{}),h(this,"sliderOriginalFrom",0),h(this,"sliderOriginalTo",4e3),h(this,"sliderFrom",this.sliderOriginalFrom),h(this,"sliderTo",this.sliderOriginalTo),h(this,"filterProducts",async e=>{const{type:t,detail:s}=e;if("range-select"===t){const{from:e,to:t}=s;this.sliderFrom=e,this.sliderTo=t}this.components.sortableTable.start=1,this.components.sortableTable.end=1+this.components.sortableTable.step;const{sorted:i,start:n,end:r,element:a}=this.components.sortableTable,{id:l,order:o}=i;a.classList.add("sortable-table_loading");const{subElements:h}=this.components.sortPanel,{filterName:c,filterStatus:m}=h,{value:u}=c,{value:b}=m,p=new URL("api/rest/products","https://course-js.javascript.ru/");p.searchParams.set("price_gte",this.sliderFrom),p.searchParams.set("price_lte",this.sliderTo),u&&p.searchParams.set("title_like",u),b&&p.searchParams.set("status",b),p.searchParams.set("_sort",l),p.searchParams.set("_order",o),p.searchParams.set("_start",n),p.searchParams.set("_end",r),this.components.sortableTable.filtered={price_gte:this.sliderFrom,price_lte:this.sliderTo,title_like:u,status:b};const g=await(0,d.Z)(p);this.components.sortableTable.addRows(g),a.classList.remove("sortable-table_loading")}),h(this,"resetFilters",e=>{e.preventDefault();const{subElements:t,components:s}=this.components.sortPanel,{filterName:i,filterStatus:n}=t,{doubleSlider:r}=s;i.value="",n.value="",this.sliderFrom=this.sliderOriginalFrom,this.sliderTo=this.sliderOriginalTo,r.reset(),this.filterProducts(e)})}async initComponents(){const e=new Date,t=(new Date(e.getTime()-2592e6),new l({sliderMin:this.sliderFrom,sliderMax:this.sliderTo})),s=new i.Z(o,{url:"api/rest/products?_embed=subcategory.category&_sort=title&_order=asc&_start=0&_end=30"});this.components.sortPanel=t,this.components.sortableTable=s}get template(){return'\n    <div class="products-list">\n      <div class="content__top-panel">\n        <h1 class="page-title">Товары</h1>\n        <a href="/products/add" class="button-primary">Добавить товар</a>\n      </div>\n      <div data-element="sortPanel">\n        \x3c!-- sort-panel component --\x3e\n      </div>\n      <div data-element="sortableTable">\n        \x3c!-- sortable-table component --\x3e\n      </div>\n    </div>'}async render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element),await this.initComponents(),this.renderComponents(),this.modifyEmptyPlaceholder(),this.initEventListeners(),this.element}initEventListeners(){const{subElements:e}=this.components.sortPanel,{filterName:t,filterStatus:s}=e,i=this.element.querySelector(".button-primary-outline");for(const e of[t,s])e.addEventListener("input",this.filterProducts);i.addEventListener("click",this.resetFilters),this.element.addEventListener("range-select",this.filterProducts)}removeEventListeners(){const{subElements:e}=this.components.sortPanel,{filterName:t,filterStatus:s}=e,i=this.element.querySelector(".button-primary-outline");for(const e of[t,s])e.removeEventListener("input",this.filterProducts);i.removeEventListener("click",this.resetFilters),this.element.removeEventListener("range-select",this.filterProducts)}modifyEmptyPlaceholder(){const{subElements:e}=this.components.sortableTable,{emptyPlaceholder:t}=e;t.innerHTML='\n      <div>\n        <p>Не найдено товаров удовлетворяющих выбранному критерию</p>\n        <button type="button" class="button-primary-outline">Очистить фильтры</button>\n      </div>\n    '}renderComponents(){Object.keys(this.components).forEach(e=>{const t=this.subElements[e],{element:s}=this.components[e];t.append(s)})}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}destroy(){this.removeEventListeners();for(const e of Object.values(this.components))e.destroy()}}},856:(e,t,s)=>{async function i(e,t){let s,i;try{s=await fetch(e.toString(),t)}catch(e){throw new n(s,"Network error has occurred.")}if(!s.ok){let e=s.statusText;try{i=await s.json(),e=i.error&&i.error.message||i.data&&i.data.error&&i.data.error.message||e}catch(e){}let t=`Error ${s.status}: ${e}`;throw new n(s,i,t)}try{return await s.json()}catch(e){throw new n(s,null,e.message)}}s.d(t,{Z:()=>i});class n extends Error{constructor(e,t,s){var i,n,r;super(s),r="FetchError",(n="name")in(i=this)?Object.defineProperty(i,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):i[n]=r,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof n&&alert(e.reason.message)})}}]);
//# sourceMappingURL=products-list-index-js-197.js.map