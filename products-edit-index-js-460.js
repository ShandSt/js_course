"use strict";(self.webpackChunkproject_structure=self.webpackChunkproject_structure||[]).push([[460],{842:(e,t,n)=>{function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{Z:()=>s});class s{constructor(e){let{duration:t,type:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,"element",void 0),this.message=e,this.duration=t,this.type=n,this.render()}get template(){return`\n      <div class="notification notification_${this.type} show" style="--value:${this.duration/1e3}s">\n        <div class="notification__content">\n          ${this.message}\n        </div>\n      </div>\n    `}render(){s.activeComponent&&s.activeComponent.remove();const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild,s.activeComponent=this.element}show(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.body).append(this.element),setTimeout(()=>{this.remove()},this.duration)}remove(){this.element.remove()}destroy(){this.remove()}}i(s,"activeComponent",void 0)},523:(e,t,n)=>{function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{Z:()=>s});class s{constructor(){let{items:e=[]}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,"element",void 0),i(this,"onDocumentPointerMove",e=>{let{clientX:t,clientY:n}=e;this.moveDraggingAt(t,n);const{firstElementChild:i,children:s}=this.element,{top:l}=i.getBoundingClientRect(),{bottom:o}=this.element.getBoundingClientRect();if(n<l)this.movePlaceholderAt(0);else if(n>o)this.movePlaceholderAt(s.length);else for(let e=0;e<s.length;e++){const t=s[e];if(t!==this.draggingElem){const{top:i,bottom:s}=t.getBoundingClientRect(),{offsetHeight:l}=t;if(n>i&&n<s){if(n<i+l/2){this.movePlaceholderAt(e);break}this.movePlaceholderAt(e+1);break}}}this.scrollIfCloseToWindowEdge(n)}),i(this,"onDocumentPointerUp",()=>{this.dragStop()}),this.items=e,this.render()}render(){this.element=document.createElement("ul"),this.element.className="sortable-list",this.addItems(),this.initEventListeners()}initEventListeners(){this.element.addEventListener("pointerdown",e=>this.onPointerDown(e))}addItems(){for(let e of this.items)e.classList.add("sortable-list__item");this.element.append(...this.items)}onPointerDown(e){if(1!==e.which)return!1;const t=e.target.closest(".sortable-list__item");t&&(e.target.closest("[data-grab-handle]")&&(e.preventDefault(),this.dragStart(t,e)),e.target.closest("[data-delete-handle]")&&(e.preventDefault(),t.remove()))}dragStart(e,t){let{clientX:n,clientY:i}=t;this.elementInitialIndex=[...this.element.children].indexOf(e),this.pointerInitialShift={x:n-e.getBoundingClientRect().x,y:i-e.getBoundingClientRect().y},this.draggingElem=e,this.placeholderElem=document.createElement("li"),this.placeholderElem.className="sortable-list__placeholder",e.style.width=e.offsetWidth+"px",e.style.height=e.offsetHeight+"px",this.placeholderElem.style.width=e.style.width,this.placeholderElem.style.height=e.style.height,e.classList.add("sortable-list__item_dragging"),e.after(this.placeholderElem),this.element.append(e),this.moveDraggingAt(n,i),document.addEventListener("pointermove",this.onDocumentPointerMove),document.addEventListener("pointerup",this.onDocumentPointerUp)}moveDraggingAt(e,t){this.draggingElem.style.left=e-this.pointerInitialShift.x+"px",this.draggingElem.style.top=t-this.pointerInitialShift.y+"px"}scrollIfCloseToWindowEdge(e){e<20?window.scrollBy(0,-10):e>document.documentElement.clientHeight-20&&window.scrollBy(0,10)}movePlaceholderAt(e){const t=this.element.children[e];t!==this.placeholderElem&&this.element.insertBefore(this.placeholderElem,t)}dragStop(){const e=[...this.element.children].indexOf(this.placeholderElem);this.placeholderElem.replaceWith(this.draggingElem),this.draggingElem.classList.remove("sortable-list__item_dragging"),this.draggingElem.style.left="",this.draggingElem.style.top="",this.draggingElem.style.width="",this.draggingElem.style.height="",document.removeEventListener("pointermove",this.onDocumentPointerMove),document.removeEventListener("pointerup",this.onDocumentPointerUp),this.draggingElem=null,e!==this.elementInitialIndex&&this.element.dispatchEvent(new CustomEvent("sortable-list-reorder",{bubbles:!0,detail:{from:this.elementInitialIndex,to:e}}))}remove(){this.element.remove(),document.removeEventListener("pointermove",this.onDocumentPointerMove),document.removeEventListener("pointerup",this.onDocumentPointerUp)}destroy(){this.remove()}}},386:(e,t,n)=>{n.r(t),n.d(t,{default:()=>d});var i=n(523),s=n(842),l=n(731),o=n(856);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class a{async sendFormData(e){const t=this.getFetchUrl(this.productsUrl),n={method:this.productId?"PATCH":"PUT",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(e)};await(0,o.Z)(t,n);const i=this.productEditMode?"product-updated":"product-saved";this.element.dispatchEvent(new CustomEvent(i,{bubbles:!0,detail:event}))}showNotificationMessage(e){let{duration:t=2e3,type:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};new s.Z(e,{duration:t,type:n}).show()}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"api/rest/products";r(this,"element",void 0),r(this,"inputElement",void 0),r(this,"productData",null),r(this,"categories",null),r(this,"onFormSubmit",e=>{e.preventDefault();const{productForm:t,imageListContainer:n}=this.subElements,i=new FormData(t),s={},l=["title","description","subcategory","price","quantity","discount","status"],o=["price","quantity","discount","status"];for(let[e,t]of i)l.includes(e)&&(t=o.includes(e)?parseInt(t,10):t,s[e]=t);this.productEditMode&&(s.id=this.productId),s.images=[];const r=n.querySelectorAll(".sortable-table__cell-img");for(const e of r){const{alt:t,src:n}=e;s.images.push({url:n,source:t})}this.sendFormData(s)}),r(this,"uploadImage",async()=>{const[e]=this.inputElement.files;if(!e)return;const t=new FormData;t.append("image",e);const{lastElementChild:n}=this.subElements["sortable-list-container"];let i;n.classList.add("is-loading");try{i=await(0,o.Z)("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID 28aaa2e823b03b1"},body:t}),this.showNotificationMessage("Image upload succeeded!",{type:"success"}),this.appendUploadedImageToSortableList(e,i)}catch(e){this.showNotificationMessage("Upload to the server failed! Please try again later! "+e,{type:"error",duration:3e3})}finally{n.classList.remove("is-loading")}}),r(this,"appendUploadedImageToSortableList",(e,t)=>{const{name:n}=e,{link:s}=t.data,{firstElementChild:l}=this.subElements.imageListContainer,o=[{url:s,source:n}].map(e=>{let{url:t,source:n}=e;return this.getImageItem(t,n)}),r=new i.Z({items:o});l.append(r.element)}),r(this,"onUploadImageButtonClick",e=>{e.preventDefault();const t=document.createElement("div");t.innerHTML='<input type="file" accept="image/*" hidden="">',this.inputElement=t.firstElementChild,document.body.append(this.inputElement),this.inputElement.onchange=this.uploadImage,this.inputElement.click()}),this.productId=e,this.productEditMode=Boolean(this.productId),this.productsUrl=t,this.categoriesUrl="api/rest/categories"}async render(){const e=document.createElement("div");[this.categories,this.productData]=await this.getAllData(this.productEditMode),this.productEditMode?e.innerHTML=this.getEditProductFormTemplate(this.productData,this.categories):e.innerHTML=this.getCreateProductFormTemplate(this.categories);const t=e.firstElementChild;return this.element=t,this.subElements=this.getSubElements(),this.createImagesList(),this.initEventListeners(),this.element}initEventListeners(){this.subElements["sortable-list-container"].lastElementChild.addEventListener("click",this.onUploadImageButtonClick),this.element.addEventListener("submit",this.onFormSubmit)}async getAllData(e){const t=[this.getSingleData(this.categoriesUrl,{_sort:"weight",_refs:"subcategory"})];if(e){const e=this.getSingleData(this.productsUrl,{id:this.productId});t.push(e)}return await Promise.all(t)}async getSingleData(e,t){const n=this.getFetchUrl(e,t);return await(0,o.Z)(n)}getFetchUrl(e,t){const n=new URL(e,"https://course-js.javascript.ru/");if(t)for(let[e,i]of Object.entries(t))n.searchParams.set(e,i);return n}getSubElements(){return[...(arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.element).querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}getEditProductFormTemplate(e,t){let[n]=e;return`\n      <div class="product-form">\n        <form data-element="productForm" class="form-grid">\n          ${this.getTitleTemplate(n)}\n          ${this.getDescriptionTemplate(n)}\n          ${this.getSortableImageListContainerTemplate()}\n          ${this.getProductCategoriesTemplate(t,n)}\n          ${this.getProductPriceDiscountTemplate(n)}\n          ${this.getProductQuantityTemplate(n)}\n          ${this.getProductStatusTemplate(n)}\n          <div class="form-buttons">\n            <button type="submit" name="save" class="button-primary-outline">\n              Сохранить товар\n            </button>\n          </div>\n        </form>\n      </div>\n    `}getTitleTemplate(e){let{title:t}=e;return`\n      <div class="form-group form-group__half_left">\n        <fieldset>\n          <label class="form-label">Название товара</label>\n          <input required="" type="text" name="title" class="form-control" placeholder="Название товара" value="${(0,l.Z)(t)}">\n        </fieldset>\n      </div>\n    `}getDescriptionTemplate(e){let{description:t}=e;return`\n      <div class="form-group form-group__wide">\n        <label class="form-label">Описание</label>\n        <textarea required="" class="form-control" name="description" data-element="productDescription" placeholder="Описание товара">${(0,l.Z)(t)}"</textarea>\n      </div>\n    `}getSortableImageListContainerTemplate(){return'\n      <div class="form-group form-group__wide" data-element="sortable-list-container">\n        <label class="form-label">Фото</label>\n        <div data-element="imageListContainer">\n        </div>\n        <button type="button" name="uploadImage" class="button-primary-outline"><span>Загрузить</span></button>\n      </div>\n    '}getProductCategoriesTemplate(e,t){let n;return t&&({subcategory:n}=t),`\n      <div class="form-group form-group__half_left">\n        <label class="form-label">Категория</label>\n        <select class="form-control" name="subcategory">\n        ${e.map(e=>{let{title:t,subcategories:i}=e;return i.map(e=>{let{id:i,title:s}=e;return`\n                  <option ${n&&n===i?"selected":""} value="${i}">${t} &gt; ${s}</option>\n                `})}).join("")}\n        </select>\n      </div>\n    `}getProductPriceDiscountTemplate(e){let{price:t,discount:n}=e;return`\n      <div class="form-group form-group__half_left form-group__two-col">\n        <fieldset>\n          <label class="form-label">Цена ($)</label>\n          <input required="" type="number" name="price" class="form-control" placeholder="100" value="${t}">\n        </fieldset>\n        <fieldset>\n          <label class="form-label">Скидка ($)</label>\n          <input required="" type="number" name="discount" class="form-control" placeholder="0" value="${n}">\n        </fieldset>\n      </div>\n    `}getProductQuantityTemplate(e){let{quantity:t}=e;return`\n      <div class="form-group form-group__part-half">\n        <label class="form-label">Количество</label>\n        <input required="" type="number" class="form-control" name="quantity" placeholder="1" value="${t}">\n      </div>\n    `}getProductStatusTemplate(e){let{status:t}=e;return`\n      <div class="form-group form-group__part-half">\n        <label class="form-label">Статус</label>\n        <select class="form-control" name="status">\n          <option ${1===t?"selected":""} value="1">Активен</option>\n          <option ${0===t?"selected":""} value="0">Неактивен</option>\n        </select>\n      </div>\n    `}createImagesList(){if(!this.productData)return;const{imageListContainer:e}=this.subElements,[t]=this.productData,{images:n}=t,s=n.map(e=>{let{url:t,source:n}=e;return this.getImageItem(t,n)}),l=new i.Z({items:s});e.append(l.element)}getImageItem(e,t){const n=document.createElement("div");return n.innerHTML=`\n      <li class="products-edit__imagelist-item sortable-list__item">\n        <span>\n          <img src="icon-grab.svg" data-grab-handle alt="grab">\n          <img class="sortable-table__cell-img" alt="${(0,l.Z)(t)}" src="${(0,l.Z)(e)}">\n          <span>${(0,l.Z)(t)}</span>\n        </span>\n        <button type="button">\n          <img src="icon-trash.svg" alt="delete" data-delete-handle>\n        </button>\n      </li>`,n.firstElementChild}getCreateProductFormTemplate(e){return`\n      <div class="product-form">\n        <form data-element="productForm" class="form-grid">\n        <div class="form-group form-group__half_left">\n          <fieldset>\n            <label class="form-label">Название товара</label>\n            <input required="" type="text" name="title" class="form-control" placeholder="Название товара">\n          </fieldset>\n        </div>\n        <div class="form-group form-group__wide">\n          <label class="form-label">Описание</label>\n          <textarea required="" class="form-control" name="description" data-element="productDescription" placeholder="Описание товара"></textarea>\n        </div>\n        <div class="form-group form-group__wide" data-element="sortable-list-container">\n          <label class="form-label">Фото</label>\n          <div data-element="imageListContainer"><ul class="sortable-list"></ul></div>\n          <button type="button" name="uploadImage" class="button-primary-outline fit-content"><span>Загрузить</span></button>\n        </div>\n        ${this.getProductCategoriesTemplate(e)}\n        <div class="form-group form-group__half_left form-group__two-col">\n          <fieldset>\n            <label class="form-label">Цена ($)</label>\n            <input required="" type="number" name="price" class="form-control" placeholder="100">\n          </fieldset>\n          <fieldset>\n            <label class="form-label">Скидка ($)</label>\n            <input required="" type="number" name="discount" class="form-control" placeholder="0">\n          </fieldset>\n        </div>\n        <div class="form-group form-group__part-half">\n          <label class="form-label">Количество</label>\n          <input required="" type="number" class="form-control" name="quantity" placeholder="1">\n        </div>\n        <div class="form-group form-group__part-half">\n          <label class="form-label">Статус</label>\n          <select class="form-control" name="status">\n            <option value="1">Активен</option>\n            <option value="0">Неактивен</option>\n          </select>\n        </div>\n        <div class="form-buttons">\n          <button type="submit" name="save" class="button-primary-outline">\n            Добавить товар\n          </button>\n        </div>\n      </form>\n      </div>\n    `}remove(){this.element.remove()}destroy(){this.remove(),this.subElements={}}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class d{constructor(e){c(this,"element",void 0),c(this,"subElements",{}),c(this,"components",{}),this.match=e}async initComponents(){const[,e]=this.match,t=new a(e);await t.render(),this.components.productForm=t}get template(){return'\n    <div class="products-edit">\n      <div class="content__top-panel">\n        <h1 class="page-title">\n          <a href="/products" class="link">Товары</a> / Добавить\n        </h1>\n      </div>\n      <div class="content-box">\n        <div data-element="productForm">\n          \x3c!-- product-form component --\x3e\n        </div>\n      </div>\n    </div>'}async render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element),await this.initComponents(),this.renderComponents(),this.element}renderComponents(){Object.keys(this.components).forEach(e=>{const t=this.subElements[e],{element:n}=this.components[e];t.append(n)})}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}destroy(){for(const e of Object.values(this.components))e.destroy()}}},731:(e,t,n)=>{n.d(t,{Z:()=>i});const i=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},856:(e,t,n)=>{async function i(e,t){let n,i;try{n=await fetch(e.toString(),t)}catch(e){throw new s(n,"Network error has occurred.")}if(!n.ok){let e=n.statusText;try{i=await n.json(),e=i.error&&i.error.message||i.data&&i.data.error&&i.data.error.message||e}catch(e){}let t=`Error ${n.status}: ${e}`;throw new s(n,i,t)}try{return await n.json()}catch(e){throw new s(n,null,e.message)}}n.d(t,{Z:()=>i});class s extends Error{constructor(e,t,n){var i,s,l;super(n),l="FetchError",(s="name")in(i=this)?Object.defineProperty(i,s,{value:l,enumerable:!0,configurable:!0,writable:!0}):i[s]=l,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof s&&alert(e.reason.message)})}}]);
//# sourceMappingURL=products-edit-index-js-460.js.map